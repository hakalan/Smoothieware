function runCommand(e,t){t("ok "+e+": 12345");return;if(!busy){busy=true;var n=$("#address").val()+"/command";e+="\n";$.post(n,e,t).fail(function(){log("Failed!")}).always(function(){busy=false})}else{$("#result").text("Busy!")}}function log(e){var t=$("#commandlog");t.append(e+"\n");t.scrollTop(t.prop("scrollHeight"))}function logCommand(e,t){log(e);runCommand(e,function(e){log(e);if(t)t(e)})}function send(e){cmd=$("#commandText").val();logCommand(cmd);$("#commands").append('<option value="'+cmd+'"></option>')}function jogXYClick(e){runCommand("G91 G0 "+e+" F"+$("#xy_velocity").val()+" G90")}function jogZClick(e){runCommand("G91 G0 "+e+" F"+$("#z_velocity").val()+" G90")}function extrude(e,t,n){var r=$("#extrude_length").val();var i=$("#extrude_velocity").val();var s=e.currentTarget.id=="extrude"?1:-1;runCommand("G91 G0 E"+r*s+" F"+i+" G90")}function motorsOff(e){runCommand("M18")}function heatSet(e){var t=e.currentTarget.id=="heat_set"?104:140;var n=t==104?$("#heat_value").val():$("#bed_value").val();runCommand("M"+t+" S"+n)}function heatOff(e){var t=e.currentTarget.id=="heat_off"?104:140;runCommand("M"+t+" S0")}function getTemperature(){runCommand("M105",false)}function startGraph(){updateGraph()}function pushData(e,t){if(t.length>totalPoints){t.shift()}t.push(e);var n=[];for(var r=0;r<t.length;++r){n.push([r,t[r]])}return n}function addTemp(e){var t=/([A-Z]):([0-9.]+)\/([0-9.]+).*([A-Z]):([0-9.]+)\/([0-9.]+)/;var n=t.exec(e);var r=pushData(Number(n[2]),data1);var i=pushData(Number(n[5]),data2);var s=Number(n[3]);var o=Number(n[6]);plot.setData([{label:n[1],lines:{lineWidth:3},data:r},{lines:{lineWidth:1},data:[[0,s],[totalPoints,s]]},{label:n[4],lines:{lineWidth:3},data:i},{lines:{lineWidth:1},data:[[0,o],[totalPoints,o]]}]);plot.setupGrid();plot.draw();var u=$("#updateInterval").val();graphTimer=setTimeout(enableGraph,u)}function fake(){xx+=.05;return"T:"+(100+Math.sin(xx)*100)+"/200 @0 "+"B:"+(50+Math.cos(xx)*50)+"/55 @0"}function enableGraph(){if($("#enablegraph").is(":checked")){if($("#sim").is(":checked")){addTemp(fake())}else{runCommand("M105",addTemp)}}else{clearTimeout(graphTimer)}}function fanSet(e){runCommand("M106 S"+$("#fan_value").val())}function fanOff(){$("#fan_value").val(0);runCommand("M107")}function handleFileSelect(e){var t=e.target.files;var n=[];for(var r=0,i;i=t[r];r++){n.push("<li><strong>",escape(i.name),"</strong> (",i.type||"n/a",") - ",i.size," bytes, last modified: ",i.lastModifiedDate?i.lastModifiedDate.toLocaleDateString():"n/a","</li>")}document.getElementById("list").innerHTML="<ul>"+n.join("")+"</ul>"}function upload(){$("#progress").empty();$("#uploadresult").empty();var e=document.getElementById("files").files[0];var t=new FileReader;t.readAsBinaryString(e);t.onloadend=function(t){xhr=new XMLHttpRequest;xhr.open("POST","upload",true);xhr.setRequestHeader("X-Filename",e.name);XMLHttpRequest.prototype.mySendAsBinary=function(e){var t=new ArrayBuffer(e.length);var n=new Uint8Array(t,0);for(var r=0;r<e.length;r++)n[r]=e.charCodeAt(r)&255;if(typeof window.Blob=="function"){var i=new Blob([t])}else{var s=new(window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder);s.append(t);var i=s.getBlob()}this.send(i)};var n=xhr.upload||xhr;n.addEventListener("progress",function(e){var t=e.position||e.loaded;var n=e.totalSize||e.total;var r=Math.round(t/n*100);$("#progress").empty().append("uploaded "+r+"%")});xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200){$("#uploadresult").empty().append("Uploaded Ok")}else{$("#uploadresult").empty().append("Uploaded Failed")}}};xhr.mySendAsBinary(t.target.result)}}function playFile(e){runCommand("play /sd/"+e)}function refreshFiles(){document.getElementById("fileList").innerHTML="";runCommand("M20",function(e){$.each(e.split("\n"),function(e){var t=this.trim();if(t.match(/\.g(code)?$/)){var n=document.getElementById("fileList");var r=n.insertRow(-1);var i=r.insertCell(0);var s=document.createTextNode(t);i.appendChild(s);i=r.insertCell(1);i.innerHTML="[<a href='javascript:void(0);' onclick='playFile(\""+t+"\");'>Play</a>]"}})})}var busy=false;var plot,data1=[],data2=[],totalPoints=100,graphTimer;$(function(){var e=$("#heat_value").val();var t=$("#bed_value").val();plot=$.plot("#tempGraph",[],{series:{shadowSize:0},yaxis:{min:0},xaxis:{min:0,max:totalPoints,show:false},colors:["#d00000","#e02020","#0000d0","#2020e0"],legend:{position:"nw"}});plot.draw()});var xx=0;$(function(){document.getElementById("files").addEventListener("change",handleFileSelect,false)})